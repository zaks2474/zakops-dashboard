# Chat UI Hardening (RCA + Fix Summary)

This document explains the root causes behind the Web UI failures on `/chat` and the concrete fixes applied across the Next.js frontend and FastAPI backend.

## 1) Approve/Reject failures (proposal execution)

### Symptoms observed in Web UI
- `"Unknown proposal type: schedule_action"`
- `"Proposal status is failed"`
- FastAPI validation error: `{"loc":["body","content"],"msg":"Input should be a valid string","input":null}`

### Root causes
- **Proposal parsing bug (nested params lost)**: the backend proposal parser in `scripts/chat_orchestrator.py` was stripping indentation before checking for nested `params:` entries. That caused `params.content` to never populate, and the executor then derived `content = None`, leading to validation errors (or failed proposals that could not be retried).
- **Proposal type taxonomy drift**: the LLM/UI could produce `schedule_action` while the backend executor only supported the other canonical name (`create_task`), resulting in `"Unknown proposal type"` errors.
- **Proposal lifecycle mismatch**: once a proposal was marked `failed`, the previous execution path could reject retries (causing `"Proposal status is failed"` even after the underlying bug was fixed).

### Fixes applied
- **Robust proposal parsing**: `scripts/chat_orchestrator.py` now supports:
  - JSON proposal blocks
  - YAML-like blocks with indented `params:`
  - Back-compat recovery (moves known top-level fields into `params`)
- **Strict canonical proposal types + alias mapping**:
  - Canonical enum: `add_note`, `create_task`, `draft_email`, `stage_transition`, `request_docs`
  - Alias mapping includes `schedule_action → create_task` in both backend and frontend.
- **Execution hardening**:
  - Early param validation (`invalid_proposal_params`) and clearer reason codes.
  - Allow retrying execution from `failed` status.
  - Persist proposal status/result updates in SQLite so refresh/restart does not regress state.

## 2) Chat page scrolling / “stuck” scroll

### Symptoms
- Chat history was not scrollable, or scrolling “snapped” back to bottom while streaming.

### Root cause
- The scroll tracking used a ref passed into a component that did not forward refs reliably, so the scroll listener never attached. The UI believed it was always “near bottom”, and auto-scrolled aggressively during streaming updates.

### Fix
- Replaced the chat history region with a plain scroll container (`div` with `overflow-y-auto` + `min-h-0`) and explicit near-bottom tracking:
  - Auto-scroll to bottom only when the user is near bottom.
  - If the user scrolls up, streaming tokens no longer force-scroll the view.

## 3) Email drafting routing (Gemini Pro requirement)

### Requirement
- Broker email drafting must be generated by **Gemini Pro** (not local vLLM), and the UI must show which provider/model was used.

### Fix
- Backend email drafting path is now policy-enforced:
  - `scripts/chat_orchestrator.py:_generate_broker_email()` requires Gemini Pro and returns strict JSON (`{subject, body}`) only.
  - If cloud is disabled or Gemini is unhealthy, it fails safely with structured reason codes (`cloud_disabled`, `gemini_unavailable`, `invalid_worker_output`).
- Frontend debug panel surfaces provider/model from execution results.

## Tests added
- Backend unit tests: `/home/zaks/scripts/tests/test_chat_orchestrator_proposals.py`
- Persistence regression test: `/home/zaks/scripts/tests/test_chat_persistence.py`
- UI E2E tests (Playwright): `zakops-dashboard/e2e/chat.spec.ts`

## Definition of Done (manual verification checklist)
- Visit `http://localhost:3003/chat?deal_id=DEAL-2025-008`:
  - Generate an `add_note` proposal → click **Approve** → card shows `executed` and displays `Note saved`.
  - Generate a `create_task` (or `schedule_action`) proposal → click **Approve** → card shows `executed`.
- Visit `http://localhost:3003/chat?deal_id=DEAL-2025-010`:
  - Generate a `draft_email` proposal → click **Approve** → debug panel shows `provider=gemini-pro` and a Gemini Pro model.
- Scrolling:
  - Scroll up in history, send another message, and confirm streaming does not snap back to bottom unless you were already near bottom.
